
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Socket Programming: IPv6 Extension Headers - Erik Bergenholtz' blog</title>
  <meta name="author" content="Erik Bergenholtz">

  
  <meta name="description" content="Recently in my research I had to deal with the IPv6 extension headers. In
particular I had to deal with the Hop-By-Hop header. Unfortunately, the &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.erikbergenholtz.se/blog/2018/01/11/socket-programming-ipv6-extension-headers/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Erik Bergenholtz' blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup class="hCont">
  <h1><a href="/">Erik Bergenholtz' blog</a></h1>
  
    <h2>Ramblings about technical things</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.erikbergenholtz.se">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Socket Programming: IPv6 Extension Headers</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-01-11T19:04:09+01:00'><span class='date'>2018-01-11</span> <span class='time'>7:04 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Recently in my research I had to deal with the IPv6 extension headers. In
particular I had to deal with the Hop-By-Hop header. Unfortunately, the process
of actually setting the option and getting it on the wire is not trivial, and
the documentation is so-so. Because of this I thought I&rsquo;d give explaining the
process a go. But firstly, let&rsquo;s discuss the header itself.</p>

<h2>IPv6 Extension Headers</h2>

<p>The two extensions headers that are covered by this method are the Hob-by-Hop
options header and the destination options header.</p>

<figure class='code'><figcaption><span>IPv6 extension header</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</span><span class='line'>|  Next Header  |  Hdr Ext Len  |                               |
</span><span class='line'>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               +
</span><span class='line'>|                                                               |
</span><span class='line'>.                                                               .
</span><span class='line'>.                            Options                            .
</span><span class='line'>.                                                               .
</span><span class='line'>|                                                               |
</span><span class='line'>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</span></code></pre></td></tr></table></div></figure>


<p>The headers looks like above. The first field is a 8-bit field that tells us
what the next header after the current one is. Following that is another 8-bit
field which tells us how long the current field is in units of <em>8 bytes</em>. It
should be noted, however, that this length does <em>not</em> include the first 8 bytes.
In other words, if the header is 8 bytes long the length field will hold the
value 0, while if the header is 16 bytes long it will hold the value 1.</p>

<p>After these two fields comes the actual options. They follow the below format,
and must be a multiple of 8 bytes long. If they&rsquo;re too short they&rsquo;re padded to
an acceptable lenght.</p>

<figure class='code'><figcaption><span>Extension option fields</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+- - - - - - - - -
</span><span class='line'>|  Option Type  |  Opt Data Len |  Option Data
</span><span class='line'>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+- - - - - - - - -
</span></code></pre></td></tr></table></div></figure>


<p>The first field tells us the type of the option. The most significant bits of
this value determines how the packet is treated, according to the following
table:</p>

<figure class='code'><figcaption><span>MSB meaning</span><a href='https://tools.ietf.org/html/rfc2460'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>+-------------------------------------------------------------------------+
</span><span class='line'>| MSB | Description                                                       |
</span><span class='line'>+-----+-------------------------------------------------------------------+
</span><span class='line'>| 00  | Skip this option and keep processing the header                   |
</span><span class='line'>+-----+-------------------------------------------------------------------+
</span><span class='line'>| 01  | Discard the packet                                                |
</span><span class='line'>+-----+-------------------------------------------------------------------+
</span><span class='line'>| 10  | Drop the packet and return an IMCP parameter probelm packet,      |
</span><span class='line'>|     | regardless of whether or not the destination address is multicast |
</span><span class='line'>+-----+-------------------------------------------------------------------+
</span><span class='line'>| 11  | Drop the packet and return an ICMP parameter problem packet, but  |
</span><span class='line'>|     | *only* if the destination address is not multicast                |
</span><span class='line'>+-----+-------------------------------------------------------------------+
</span></code></pre></td></tr></table></div></figure>


<p>The thrid most significant bit tells us if the option can change in en-route
(<code>1</code>) or not (<code>0</code>). The option length field says how many bytes long the option
is.</p>

<p>For the purposes of this guide, that is all you need to know. As you can see
from the MSB meaning table, these options aren&rsquo;t extremely useful if you follow
the RFC, as they all either tells the receiver to ignore the option or drop the
packet, but they might become useful in the future. Who knows.</p>

<h2>Adding the extension headers to packets</h2>

<p>And now we&rsquo;re reached the reason you&rsquo;re here; how do we actually make our
packets that we put on the wire have these options? Unless you want to manually
build the whole packet yourself, by hand (which is of course possible), the way
to do it is to use <code>struct cmsghdr</code>. These structs, which hold message control
data, are used by <code>struct msghdr</code> when using <code>sendmsg(...)</code> to send packets.
Since building packets by hand is a bit awkward and messy, this approach is what
we&rsquo;ll do. So let&rsquo;s get to it!</p>

<p>The very first step is to create a socket, regardless of method, so let&rsquo;s start
with that. I am going to create a raw socket that can then be used to issue
ICMP messages. To create this socket we do the following:</p>

<figure class='code'><figcaption><span>Create raw socket</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;errno.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/socket.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;arpa/inet.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">fatal</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
</span><span class='line'>   <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">sockfd</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span><span class="p">((</span><span class="n">sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET6</span><span class="p">,</span> <span class="n">SOCK_RAW</span><span class="p">,</span> <span class="n">IPPROTO_ICMPV6</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>   <span class="n">fatal</span><span class="p">(</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>This creates a raw IPv6 socket that is meant to send ICMPv6 messages. If
something goes wrong, and error message is printed to <code>stderr</code> and the program
is shut down.</p>

<p>Now that we have our socket we&rsquo;re ready to start looking at how to send this.
As mentioned we&rsquo;re going to use <code>sendmsg(...)</code> for this, so let&rsquo;s start by
examining the function prototype for this:</p>

<figure class='code'><figcaption><span>Function prototype for sendmsg(...)</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">size_t</span> <span class="nf">sendmsg</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The function first takes a socket, of course, followed by a <code>struct msghdr *</code>
and some flags. The socket is already created, and we&rsquo;re not going to bother
with flags right now, so the value of that is 0. The thing that&rsquo;s interesting
here is the <code>struct msghdr</code>, as this structure will hold all the information
about the packet that the kernel needs to know, like destination. This is also
how we&rsquo;re going to pass the hop-by-hop header! It looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">msghdr</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">msg_name</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">socklen_t</span> <span class="n">msg_namelen</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">msg_iov</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">msg_iovlen</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">msg_control</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">msg_controllen</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">msg_flags</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first fields, <code>msg_name</code> and <code>msg_namelen</code>, are meant for the destination
address and the length of it. The next two are the I/O-vectors, or buffers
containing input. The <code>msg_control</code> and <code>msg_controllen</code> fields are the truly
interesting here, since these are where we&rsquo;ll put our <code>struct cmsghdr</code> and its
length once we&rsquo;ve build that. But let&rsquo;s build what we can, while we&rsquo;re already
looking at this. Firstly, let&rsquo;s set the IO buffers and flags, since those are
trivial.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define BUFLEN 0xffff</span>
</span><span class='line'>
</span><span class='line'><span class="p">....</span>
</span><span class='line'>
</span><span class='line'><span class="kt">char</span> <span class="n">sendbuf</span><span class="p">[</span><span class="n">BUFLEN</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">iovec</span> <span class="n">iov</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">sendbuf</span><span class="p">;</span>
</span><span class='line'><span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">BUFLEN</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span><span class='line'><span class="n">msg</span><span class="p">.</span><span class="n">msg_iov</span> <span class="o">=</span> <span class="n">iov</span><span class="p">;</span>
</span><span class='line'><span class="n">msg</span><span class="p">.</span><span class="n">msg_iovlen</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'><span class="n">msg</span><span class="p">.</span><span class="n">msg_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This piece of code creates a 65545 byte input buffer, stores it in an <code>struct
iov</code> and stores that in the <code>struct msghdr</code>. The reason the variable <code>iov</code> is
declared as an array with two elements is that we&rsquo;re gonna need that for the
options later. The next step is to set the <code>msg_name</code> and <code>msg_namelen</code> fields.
To do this we create an <code>struct sockaddr_in6</code> object and set the value of the
IP address using the <code>inet_pton(...)</code> function. We then set the <code>struct msghdr</code>
fields to point to this variable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span><span class="p">));</span>
</span><span class='line'><span class="n">inet_pton</span><span class="p">(</span><span class="n">AF_INET6</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">address</span><span class="o">&gt;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="n">msg</span><span class="p">.</span><span class="n">msg_name</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>
</span><span class='line'><span class="n">msg</span><span class="p">.</span><span class="n">msg_namelen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Exchange the <code>&lt;address&gt;</code> above with a string containing the destination address
of your packets, and you&rsquo;re good to go. Up to this point we&rsquo;ve covered most of
the preparations that are necessary to make this work. The final step, before
actually sending the packet, is to set the extension headers. The process is a
bit messy, to say the least, but I think that we&rsquo;ll be able to pull through.</p>

<p>Setting the extension header uses <code>struct cmsghdr</code>. The struct is declared as
follows:</p>

<figure class='code'><figcaption><span>Declaration of "struct cmsghdr"</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">cmsghdr</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">size_t</span> <span class="n">cmsg_len</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">cmsg_level</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">cmsg_type</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>cmsg_len</code> field contains the length of the data <em>plus</em> the length of the
header. <code>cmsg_level</code> holds the originating protocol, e.g. <code>IPPROTO_IPV6</code> in our
case. <code>cmsg_type</code> holds the message type. Since we&rsquo;re adding a hop-by-hop
header the value here will be <code>IPV6_HOPOPTS</code>. Now, it may seem like setting
these values is all we need to do to get this up and running, but it&rsquo;s quite a
bit trickier than that. This is because the struct stores the data <em>after</em> the
struct itself, so we need to initialize it carefully. For what we want to do we
need four functions and three macro functions. Let&rsquo;s start with the macros.</p>

<p><code>CMSG_LEN(len)</code> returns the length of the header and data, with any necessary
alignment taken into account. This is the value of the <code>cmsg_len</code> field. The
second macro is <code>CMSG_DATA(cmsg)</code>, which returns a pointer to the actual
ancillary data. Finally, the <code>CMSG_SPACE(len)</code> macro simply returns the
size in bytes of the ancillary data and a payload of the specified length. We
will use this to allocate space for the header.</p>

<p>The four functions we need to use are <code>inet6_opt_init(...)</code>,
<code>inet6_opt_append(...)</code>, <code>inet6_opt_set_val(...)</code> and <code>inet6_opt_finish(...)</code>.
They&rsquo;re a bit complicated, so we&rsquo;re going to go though them one by one.</p>

<p><code>inet6_opt_init(void *extbuf, socklen_t extlen)</code> is quite simple. It returns
the size of an empty header. If <code>extbuf</code> points to valid memory it also
initializes the header&rsquo;s length field. This function <em>has to be called</em> before
any of the other functions can be called.</p>

<p><code>inet6_opt_append(void *extbuf, socklen_t extlen, int offset, uint8_t type,
socklen_t len, uint8_t align, void **databufp)</code> has two jobs. If <code>extbuf</code> is
<code>NULL</code> the function returns how long the header <em>would&rsquo;ve been</em> if an option
was actually appended.  If <code>extbuf</code> is not <code>NULL</code>, on the other hand, it will
append the option, return the length as previously described <em>and</em> return a
pointer to the data through the <code>databufp</code> argument. <code>len</code> and <code>align</code> describe
the length of the option, as well as the required alignment. <code>len</code> is specified
as the number of <em>octets</em> of data. <code>align</code> cannot be exceed <code>len</code> and must have
the value <code>1</code>, <code>2</code>, <code>4</code> or <code>8</code>, which represent 0, 16, 32 or 64 bits of
alignment respectively. <code>offset</code> should be the returned value of either
<code>inet6_opt_init</code> or a previous call to <code>inet6_opt_append</code>.</p>

<p><code>inet6_opt_set_val(void *databuf, int offset, void *val, socklen_t vallen)</code>
takes a pointer to the intended data, i.e. <code>databuf</code> from the last function,
and simply writes whatever&rsquo;s stored in <code>val</code> to that position. As with the last
function, <code>offset</code> should be the returned value of the last <code>inet6_opt_append</code>
call.</p>

<p><code>inet6_opt_finish(void *extbuf, socklen_t extlen, offset)</code> calculates any final
padding needed to make the header a multiple of eight octets long. <code>offset</code> is,
as usual, the result of running <code>inet6_opt_init</code> or <code>inet6_opt_append</code>,
whichever comes last. When <code>extbuf</code> is not <code>NULL</code> the padding isn&rsquo;t just
calulated, but also added to the header.</p>

<p>So now that we know what all these things do, it&rsquo;s just a matter of applying
this. What should be noted, though, is that in order for us to know how large
our <code>struct cmsghdr</code> has to be to accomodate the header we must first do a
&ldquo;dryrun&rdquo; of the setting up. In other words, run all the functions above once
with <code>extbuf</code> set to <code>NULL</code>, then allocate memory for the struct and <em>then</em> run
all functions <em>again</em> with real values. In the end this is what it turns into:</p>

<figure class='code'><figcaption><span>Building the cmsghdr struct</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">cmsghdr</span> <span class="o">*</span><span class="n">cmsg</span><span class="p">;</span>
</span><span class='line'><span class="kt">void</span> <span class="o">*</span><span class="n">hopbuf</span><span class="p">;</span>
</span><span class='line'><span class="kt">socklen_t</span> <span class="n">hoplen</span><span class="p">;</span>
</span><span class='line'><span class="kt">void</span> <span class="o">*</span><span class="n">databuf</span><span class="p">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">curlen</span><span class="p">;</span>
</span><span class='line'><span class="kt">uint8_t</span> <span class="n">val</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Dryrun to find out size of headers</span>
</span><span class='line'><span class="k">if</span><span class="p">((</span><span class="n">curlen</span> <span class="o">=</span> <span class="n">inet6_opt_init</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>   <span class="n">fatal</span><span class="p">(</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span><span class='line'><span class="k">if</span><span class="p">((</span><span class="n">curlen</span> <span class="o">=</span> <span class="n">inet6_opt_append</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">curlen</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>   <span class="n">fatal</span><span class="p">(</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span><span class='line'><span class="k">if</span><span class="p">((</span><span class="n">curlen</span> <span class="o">=</span> <span class="n">inet6_opt_finish</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">curlen</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>   <span class="n">fatal</span><span class="p">(</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span><span class='line'><span class="n">hoplen</span> <span class="o">=</span> <span class="n">curlen</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Allocate memory and set known options</span>
</span><span class='line'><span class="n">cmsg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cmsghdr</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">CMSG_SPACE</span><span class="p">(</span><span class="n">hoplen</span><span class="p">));</span>
</span><span class='line'><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_len</span> <span class="o">=</span> <span class="n">CMSG_LEN</span><span class="p">(</span><span class="n">hoplen</span><span class="p">);</span>
</span><span class='line'><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_level</span> <span class="o">=</span> <span class="n">IPPROTO_IPV6</span><span class="p">;</span>
</span><span class='line'><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_type</span> <span class="o">=</span> <span class="n">IPV6_HOPOPTS</span><span class="p">;</span>
</span><span class='line'><span class="n">hopbuf</span> <span class="o">=</span> <span class="n">CMSG_DATA</span><span class="p">(</span><span class="n">cmsg</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Build actual header</span>
</span><span class='line'><span class="k">if</span><span class="p">((</span><span class="n">curlen</span> <span class="o">=</span> <span class="n">inet6_opt_init</span><span class="p">(</span><span class="n">hopbuf</span><span class="p">,</span> <span class="n">hoplen</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>   <span class="n">fatal</span><span class="p">(</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span><span class='line'><span class="k">if</span><span class="p">((</span><span class="n">curlen</span> <span class="o">=</span> <span class="n">inet6_opt_append</span><span class="p">(</span><span class="n">hopbuf</span><span class="p">,</span> <span class="n">hoplen</span><span class="p">,</span> <span class="n">curlen</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">databuf</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>   <span class="n">fatal</span><span class="p">(</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="n">inet6_opt_set_val</span><span class="p">(</span><span class="n">databuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>   <span class="n">fatal</span><span class="p">(</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span><span class='line'><span class="k">if</span><span class="p">((</span><span class="n">curlen</span> <span class="o">=</span> <span class="n">inet6_opt_finish</span><span class="p">(</span><span class="n">hopbuf</span><span class="p">,</span> <span class="n">hoplen</span><span class="p">,</span> <span class="n">curlen</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>   <span class="n">fatal</span><span class="p">(</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>The last step now</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Erik Bergenholtz</span></span>

      




<time class='entry-date' datetime='2018-01-11T19:04:09+01:00'><span class='date'>2018-01-11</span> <span class='time'>7:04 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://blog.erikbergenholtz.se/blog/2018/01/11/socket-programming-ipv6-extension-headers/" data-via="" data-counturl="http://blog.erikbergenholtz.se/blog/2018/01/11/socket-programming-ipv6-extension-headers/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2018/01/03/bucket-list-of-2018/" title="Previous Post: Bucket List of 2018">&laquo; Bucket List of 2018</a>
      
      
        <a class="basic-alignment right" href="/blog/2018/02/03/2018-bucket-list-january-progress/" title="Next Post: 2018 Bucket List - January progress">2018 Bucket List - January progress &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <!-- Begin MailChimp Signup Form -->
<div id="mc_embed_signup">
   <form action="//erikbergenholtz.us16.list-manage.com/subscribe/post?u=846665ee01d04e7c64e59fafa&amp;id=9d6e83f4d6" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
      <div id="mc_embed_signup_scroll">
         <h2>Get my posts in your inbox!</h2>
         <div class="mc-field-group">
            <label for="mce-EMAIL">Email Address </span>
            </label>
            <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
         </div>
         <div id="mce-responses" class="clear">
            <div class="response" id="mce-error-response" style="display:none"></div>
            <div class="response" id="mce-success-response" style="display:none"></div>
         </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
            <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_846665ee01d04e7c64e59fafa_9d6e83f4d6" tabindex="-1" value=""></div>
            <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
      </div>
   </form>
</div>

<!--End mc_embed_signup-->
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/06/08/2018-bucket-list-june-progress/">2018 Bucket List - June Progress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/02/28/2018-bucket-list-february-progress/">2018 Bucket List - February Progress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/02/03/book-review-hacking-the-art-of-exploitation/">Book Review: Hacking - the Art of Exploitation</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/02/03/2018-bucket-list-january-progress/">2018 Bucket List - January Progress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/01/11/socket-programming-ipv6-extension-headers/">Socket Programming: IPv6 Extension Headers</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Erik Bergenholtz -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'erikbergenholtz';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.erikbergenholtz.se/blog/2018/01/11/socket-programming-ipv6-extension-headers/';
        var disqus_url = 'http://blog.erikbergenholtz.se/blog/2018/01/11/socket-programming-ipv6-extension-headers/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
